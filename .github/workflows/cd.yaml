name: Continuous Delivery

on:
  workflow_run:
    workflows: ["test-and-release-beta"]
    types:
      - completed

jobs:
  cd:
    name: Generate distribution and push it
    runs-on: ubuntu-latest

    steps:
      - name: Check Out Source Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Install Node.js dependencies
        run: yarn install

      - name: Generate distribution
        run: yarn all

      - name: Setup last commit SHA (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          echo "LAST_COMMIT_SHA=${{ github.event.pull_request.head.sha }}" >> ${GITHUB_ENV}

      - name: Setup last commit SHA (Push)
        if: ${{ github.event_name == 'push' }}
        run: |
          echo "LAST_COMMIT_SHA=${GITHUB_SHA}" >> ${GITHUB_ENV}

      - name: Commit generated distribution
        env:
          LAST_COMMIT_SHA: ${{ env.LAST_COMMIT_SHA }}
          BRANCH: ${{ github.head_ref || github.ref_name }}
        run: |
          git config --global user.email "setizaps@typeform.com"
          git config --global user.name "Bender Bot Tf"
          git checkout ${BRANCH}
          git add dist/
          git commit -a -m "generates new distribution based on ${LAST_COMMIT_SHA:0:7}"
          git push --set-upstream origin ${BRANCH}
